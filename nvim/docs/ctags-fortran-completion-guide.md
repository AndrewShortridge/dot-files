# Ctags-Based Completions for Fortran with Header Files

This guide explains how to add ctag-based completions from C header files (`*.h`) to work alongside the Fortran Language Server (fortls) in your Neovim setup.

## Overview

### The Problem
Fortls handles Fortran code well but has limited support for C interoperability. When Fortran code uses `ISO_C_BINDING` to interface with C libraries, completions for C functions, macros, and types defined in `.h` files are not available through fortls.

### The Solution
Use [blink-cmp-ctags](https://github.com/netmute/blink-cmp-ctags) as a supplementary completion source that reads tags generated by [Universal Ctags](https://docs.ctags.io/en/latest/man/ctags.1.html) from your header files.

### Current Setup Summary
- **Fortls Config:** `lua/andrew/plugins/lsp/lspconfig.lua:421-469`
- **Blink.cmp Config:** `lua/andrew/plugins/blink-cmp.lua`
- **Fortls already recognizes `.h` files** via `pp_suffixes = { ".h" }`

---

## Step-by-Step Implementation

### Step 1: Install Universal Ctags

Universal Ctags is required to generate tag files from your header files.

```bash
# Ubuntu/Debian
sudo apt install universal-ctags

# Fedora
sudo dnf install ctags

# macOS
brew install universal-ctags

# Conda (if preferred)
conda install -c conda-forge universal-ctags
```

Verify installation:
```bash
ctags --version
# Should show "Universal Ctags" (not Exuberant Ctags)
```

### Step 2: Generate Tags from Header Files

Create a tags file specifically for your C header files.

#### Option A: Manual Generation
```bash
# Navigate to your project root
cd /path/to/your/project

# Generate tags from all .h files in code/ directory
ctags -f .tags-headers \
  --languages=C,C++ \
  --kinds-C=+px \
  --kinds-C++=+px \
  --fields=+iaS \
  --extras=+q \
  code/*.h
```

#### Option B: Recursive with Multiple Directories
```bash
ctags -f .tags-headers \
  --languages=C,C++ \
  --kinds-C=+pxdt \
  --fields=+iaS \
  --extras=+q \
  -R code/
```

#### Tag Kind Reference
| Kind | Description |
|------|-------------|
| `f`  | Function definitions |
| `p`  | Function prototypes/declarations |
| `d`  | Macro definitions (#define) |
| `t`  | Typedefs |
| `s`  | Structures |
| `e`  | Enumerators |
| `m`  | Structure/class members |
| `x`  | External/forward declarations |

### Step 3: Create Automatic Tag Generation Script

Create a script to regenerate tags when header files change.

**File:** `scripts/generate-header-tags.sh`
```bash
#!/bin/bash
# Generate ctags for C header files for Fortran interop completions

PROJECT_ROOT="${1:-$(pwd)}"
TAGS_FILE="${PROJECT_ROOT}/.tags-headers"
CODE_DIR="${PROJECT_ROOT}/code"

if [ ! -d "$CODE_DIR" ]; then
    echo "Error: code/ directory not found in $PROJECT_ROOT"
    exit 1
fi

ctags -f "$TAGS_FILE" \
    --languages=C,C++ \
    --kinds-C=+pxdts \
    --kinds-C++=+pxdts \
    --fields=+iaS \
    --extras=+q \
    "$CODE_DIR"/*.h 2>/dev/null || \
ctags -f "$TAGS_FILE" \
    --languages=C,C++ \
    --kinds-C=+pxdts \
    --kinds-C++=+pxdts \
    --fields=+iaS \
    --extras=+q \
    -R "$CODE_DIR"

echo "Tags generated: $TAGS_FILE"
```

Make it executable:
```bash
chmod +x scripts/generate-header-tags.sh
```

### Step 4: Install blink-cmp-ctags Plugin

Modify your blink-cmp configuration:

**File:** `lua/andrew/plugins/blink-cmp.lua`
```lua
-- =============================================================================
-- Code Completion Plugin (blink.cmp)
-- =============================================================================
-- Modern completion plugin that provides LSP-based autocomplete with snippets.
-- Documentation: https://cmp.saghen.dev/

return {
  -- Plugin: blink.cmp - A modern completion plugin for Neovim
  -- Repository: https://github.com/saghen/blink.cmp
  "saghen/blink.cmp",

  -- Event: Load plugin when entering insert mode
  event = "InsertEnter",

  -- Version constraint: Use latest 1.x stable version
  version = "1.*",

  -- =============================================================================
  -- Plugin Dependencies
  -- =============================================================================
  dependencies = {
    -- Snippet engine for snippet expansion
    {
      "L3MON4D3/LuaSnip",
      version = "v2.*",
      build = "make install_jsregexp",
      config = function()
        -- Load VSCode-style snippets from friendly-snippets
        require("luasnip.loaders.from_vscode").lazy_load()
      end,
    },

    -- Pre-built snippet collections for various languages
    "rafamadriz/friendly-snippets",

    -- Ctags completion source for C header file completions
    "netmute/blink-cmp-ctags",
  },

  -- =============================================================================
  -- Plugin Configuration
  -- =============================================================================
  opts = {
    -- Snippet engine
    snippets = {
      preset = "luasnip",
    },

    -- Keymap configuration
    keymap = {
      preset = "default",
      ["<C-k>"] = { "select_prev", "fallback" },
      ["<C-j>"] = { "select_next", "fallback" },
      ["<C-b>"] = { "scroll_documentation_up", "fallback" },
      ["<C-f>"] = { "scroll_documentation_down", "fallback" },
      ["<C-Space>"] = { "show", "fallback" },
      ["<C-e>"] = { "hide", "fallback" },
      ["<CR>"] = { "accept", "fallback" },
    },

    -- Appearance
    appearance = {
      nerd_font_variant = "mono",
    },

    -- Completion sources
    sources = {
      -- Include ctags for Fortran files to get C header completions
      default = { "lsp", "path", "snippets", "buffer", "ctags" },

      -- Configure the ctags provider
      providers = {
        ctags = {
          name = "Ctags",
          module = "blink-cmp-ctags",
          score_offset = -3,  -- Lower priority than LSP
          opts = {
            -- Look for .tags-headers file for C header completions
            tag_files = function()
              local tag_files = {}
              -- Check for header-specific tags file
              local header_tags = vim.fn.getcwd() .. "/.tags-headers"
              if vim.fn.filereadable(header_tags) == 1 then
                table.insert(tag_files, header_tags)
              end
              -- Also check standard tags file
              local standard_tags = vim.fn.getcwd() .. "/tags"
              if vim.fn.filereadable(standard_tags) == 1 then
                table.insert(tag_files, standard_tags)
              end
              return tag_files
            end,
            -- Enable caching for performance
            cache = true,
            -- Include function prototypes, macros, types, structs
            include_kinds = { "f", "p", "d", "t", "s", "e", "m" },
            -- Limit results to prevent flooding
            max_items = 100,
          },
        },
      },

      -- Enable ctags specifically for Fortran files
      per_filetype = {
        fortran = { "lsp", "path", "snippets", "buffer", "ctags" },
        f90 = { "lsp", "path", "snippets", "buffer", "ctags" },
        f95 = { "lsp", "path", "snippets", "buffer", "ctags" },
      },
    },

    -- Completion settings
    completion = {
      documentation = {
        auto_show = true,
      },
      ghost_text = {
        enabled = true,
      },
    },

    -- Fuzzy matching
    fuzzy = {
      implementation = "prefer_rust_with_warning",
    },
  },

  -- Extend sources from other plugins
  opts_extend = { "sources.default" },
}
```

### Step 5: Add Auto-Regeneration on Save (Optional)

Add an autocommand to regenerate tags when header files are saved.

**File:** `lua/andrew/plugins/lsp/lspconfig.lua` (add near the end)
```lua
-- =============================================================================
-- Auto-regenerate ctags for header files
-- =============================================================================
vim.api.nvim_create_autocmd("BufWritePost", {
  pattern = "*.h",
  callback = function()
    local project_root = vim.fn.getcwd()
    local script = project_root .. "/scripts/generate-header-tags.sh"
    if vim.fn.filereadable(script) == 1 then
      vim.fn.jobstart({ script, project_root }, { detach = true })
      vim.notify("Regenerating header tags...", vim.log.levels.INFO)
    end
  end,
  desc = "Regenerate ctags for header files on save",
})
```

### Step 6: Add User Commands for Manual Control

**File:** `lua/andrew/plugins/lsp/lspconfig.lua` (add near the end)
```lua
-- =============================================================================
-- Ctags Commands for Header Files
-- =============================================================================
vim.api.nvim_create_user_command("CtagsGenerate", function()
  local project_root = vim.fn.getcwd()
  local code_dir = project_root .. "/code"
  local tags_file = project_root .. "/.tags-headers"

  if vim.fn.isdirectory(code_dir) == 0 then
    vim.notify("Error: code/ directory not found", vim.log.levels.ERROR)
    return
  end

  local cmd = string.format(
    "ctags -f %s --languages=C,C++ --kinds-C=+pxdts --kinds-C++=+pxdts --fields=+iaS --extras=+q %s/*.h",
    vim.fn.shellescape(tags_file),
    vim.fn.shellescape(code_dir)
  )

  vim.fn.jobstart(cmd, {
    on_exit = function(_, exit_code)
      if exit_code == 0 then
        vim.schedule(function()
          vim.notify("Header tags generated: " .. tags_file, vim.log.levels.INFO)
        end)
      else
        vim.schedule(function()
          vim.notify("Failed to generate header tags", vim.log.levels.ERROR)
        end)
      end
    end,
  })
end, { desc = "Generate ctags from C header files" })

vim.api.nvim_create_user_command("CtagsInfo", function()
  local project_root = vim.fn.getcwd()
  local tags_file = project_root .. "/.tags-headers"

  if vim.fn.filereadable(tags_file) == 1 then
    local stat = vim.loop.fs_stat(tags_file)
    local size = stat and stat.size or 0
    local mtime = stat and os.date("%Y-%m-%d %H:%M:%S", stat.mtime.sec) or "unknown"
    vim.notify(string.format(
      "Header tags file: %s\nSize: %d bytes\nModified: %s",
      tags_file, size, mtime
    ), vim.log.levels.INFO)
  else
    vim.notify("No header tags file found at: " .. tags_file, vim.log.levels.WARN)
  end
end, { desc = "Show ctags header file info" })
```

---

## Usage

### Initial Setup
1. Run `:CtagsGenerate` or execute `scripts/generate-header-tags.sh`
2. Restart Neovim or run `:Lazy reload blink.cmp`

### Daily Workflow
1. Edit your Fortran files normally
2. When typing C function/macro names from headers, completions will appear
3. Ctags completions appear with LSP completions (lower priority)
4. After modifying `.h` files, regenerate tags with `:CtagsGenerate`

### Checking Status
- `:CtagsInfo` - Show tags file info
- `:BlinkCmp status` - Check if ctags provider is active

---

## How It Works Together

```
┌─────────────────────────────────────────────────────────────────┐
│                     Fortran Source File                         │
│                     (uses ISO_C_BINDING)                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      blink.cmp                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   LSP Source    │  │  Ctags Source   │  │  Other Sources  │  │
│  │   (fortls)      │  │  (C headers)    │  │  (path, buffer) │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           ▼                    ▼                    ▼           │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Merged Completion Results                       ││
│  │  - Fortran intrinsics (from fortls)                         ││
│  │  - Module symbols (from fortls)                             ││
│  │  - C functions/macros (from ctags)  ← NEW                   ││
│  │  - File paths, snippets, buffer words                       ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## Troubleshooting

### No ctags completions appearing
1. Check tags file exists: `:CtagsInfo`
2. Verify ctags provider is enabled: `:BlinkCmp status`
3. Ensure `blink-cmp-ctags` is installed: `:Lazy`
4. Check tags file content: `head .tags-headers`

### Wrong or too many completions
Adjust `include_kinds` in the ctags provider config:
- Remove `m` if struct members are unwanted
- Remove `d` if macros are causing noise

### Performance issues
- Reduce `max_items` in ctags opts
- Ensure `cache = true` is set
- Consider generating smaller, focused tag files

### Tags not updating
- Run `:CtagsGenerate` manually
- Check if the auto-save hook is working
- Verify ctags command works from terminal

---

## Files Modified

| File | Change |
|------|--------|
| `lua/andrew/plugins/blink-cmp.lua` | Add ctags dependency and provider config |
| `lua/andrew/plugins/lsp/lspconfig.lua` | Add auto-regeneration and user commands |
| `scripts/generate-header-tags.sh` | New script for tag generation |
| `.gitignore` | Add `.tags-headers` (if not tracking) |

---

## References

- [blink.cmp Documentation](https://cmp.saghen.dev/)
- [blink-cmp-ctags Plugin](https://github.com/netmute/blink-cmp-ctags)
- [Universal Ctags Manual](https://docs.ctags.io/en/latest/man/ctags.1.html)
- [Fortls Documentation](https://fortls.fortran-lang.org/)
